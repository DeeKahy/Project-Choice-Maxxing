{% extends "base.html" %} {% block title %}Manage: {{ poll.title }}{% endblock
%} {% block content %}
<div class="header-row">
    <h1>{{ poll.title }}</h1>
    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary btn-small">‚Üê Back</a>
</div>

{% if poll.description %}
<p class="text-muted">{{ poll.description }}</p>
{% endif %}

<!-- Status & Actions -->
<div class="card">
    <div class="poll-header">
        <span>Status:</span>
        <span class="status-badge {% if poll.is_open == 'true' %}status-open{% else %}status-closed{% endif %}">
            {{ 'Open' if poll.is_open == 'true' else 'Closed' }}
        </span>
    </div>

    <div class="mt-1" style="display: flex; gap: 0.5rem; flex-wrap: wrap">
        <form method="POST" action="{{ url_for('toggle_poll', poll_id=poll.id) }}" style="display: inline">
            <button type="submit" class="btn btn-small">
                {{ 'Close Poll' if poll.is_open == 'true' else 'Reopen Poll' }}
            </button>
        </form>
        <form method="POST" action="{{ url_for('delete_poll', poll_id=poll.id) }}" style="display: inline;"
            onsubmit="return confirm('Are you sure you want to delete this poll?');">
            <button type="submit" class="btn btn-danger btn-small">Delete Poll</button>
        </form>
    </div>
</div>



<!-- Voting Link -->
<div class="card">
    <h3>Share Voting Link</h3>
    <div class="copy-link">
        <input type="text" id="vote-link" value="{{ request.url_root }}vote/{{ poll.id }}" readonly />
        <button type="button" class="btn btn-small" onclick="copyLink()">
            Copy
        </button>
    </div>
</div>

<!-- Options -->
<div class="card">
    <h3>Options ({{ options|length }})</h3>
    {% for opt in options %}
    <div class="result-row">
        <span>{{ opt.name }}</span>
    </div>
    {% endfor %}
</div>

<!-- Voters -->
<div class="card">
    <h3>Votes ({{ votes|length }})</h3>
    {% if votes %} {% for vote in votes %}
    <div class="voter-item">
        <div>
            <strong>{{ vote.username }}</strong>
            <span class="text-muted" style="font-size: 0.75rem; display: block">
                {{ vote.submitted_at[:16].replace('T', ' ') }}
            </span>
        </div>
        <form method="POST" action="" onsubmit="return confirm('
            Delete vote from {{ vote.username }}?');">
            <button type="submit" class="btn btn-danger btn-small">x</button>
        </form>
    </div>
    {% endfor %} {% else %}
    <p class="text-muted">No votes yet</p>
    {% endif %}
</div>

<!-- Results -->
{% if results %}
<h2>Results</h2>

<!-- Score Voting -->
<div class="card">
    <h3>Score Voting</h3>
    <p class="text-muted" style="font-size: 0.875rem">Sum of all scores</p>
    {% for name, score in results.score_voting %}
    <div class="result-row">
        <span class="result-rank">{{ loop.index }}</span>
        <span style="flex: 1">{{ name }}</span>
        <span><strong>{{ score }}</strong> pts</span>
    </div>
    {% endfor %}
</div>

<!-- Schulze -->
<div class="card">
    <h3>Schulze Method</h3>
    <p class="text-muted" style="font-size: 0.875rem">Beatpath winner</p>
    {% for name, wins in results.schulze_method %}
    <div class="result-row">
        <span class="result-rank">{{ loop.index }}</span>
        <span style="flex: 1">{{ name }}</span>
        <span><strong>{{ wins }}</strong> wins</span>
    </div>
    {% endfor %}
</div>

<!-- Borda Count -->
<div class="card">
    <h3>Borda Count</h3>
    <p class="text-muted" style="font-size: 0.875rem">Ranked-choice converted to points</p>
    {% for name, score in results.borda_count %}
    <div class="result-row">
        <span class="result-rank">{{ loop.index }}</span>
        <span style="flex: 1">{{ name }}</span>
        <span><strong>{{ score }}</strong> pts</span>
    </div>
    {% endfor %}
</div>

<!-- STAR VOTING -->
<div class="card">
    <h3>STAR Voting</h3>
    <p class="text-muted" style="font-size: 0.875rem">Finalist winner</p>
    {% for name, wins in results.star_voting %}
    <div class="result-row">
        <span class="result-rank">{{ loop.index }}</span>
        <span style="flex: 1">{{ name }}</span>
        <span><strong>{{ wins }}</strong> wins</span>
    </div>
    {% endfor %}
</div>

{% else %}
<div class="card">
    <h3>Results</h3>
    <p class="text-muted">
        No votes yet - results will appear here once voting begins
    </p>
</div>
{% endif %}

<script>
    function copyLink() {
        const input = document.getElementById("vote-link");
        input.select();
        document.execCommand("copy");
        alert("Link copied!");
    }
</script>
{% endblock %}